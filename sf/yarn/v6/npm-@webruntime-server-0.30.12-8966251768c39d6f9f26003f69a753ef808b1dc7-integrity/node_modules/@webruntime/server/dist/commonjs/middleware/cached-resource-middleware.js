"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const utils_1 = require("../utils/utils");
const { warn } = console;
function createCachedResourceMiddleware(instance, container, config) {
    const { buildDir, server: { basePath }, } = config;
    return async (req, res, next) => {
        const { uid, mode, locale } = req.params;
        if (uid && uid !== 'latest') {
            return next();
        }
        try {
            // resolve the request url to a specifier
            const specifier = instance.toSpecifier(req.originalUrl);
            // build resource bundle for the specifier
            const bundle = await container.build(specifier, { mode, locale });
            // write the resource to the output directory.
            await utils_1.writeToOutputDir({ buildDir, mode, locale, bundle });
            // redirect to the cached resource, include base path
            return res.redirect(`${basePath}${bundle.path}`);
        }
        catch (e) {
            warn(e);
            return res.status(500).send({
                message: 'An unexpected error occurred',
                error: e.toString(),
            });
        }
    };
}
exports.createCachedResourceMiddleware = createCachedResourceMiddleware;
//# sourceMappingURL=cached-resource-middleware.js.map